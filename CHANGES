Complete change log for PanDA Pilot version PICARD
--------------------------------------------------


61a:

Added --cmtconfig to asetup in getJobExecutionCommand() to bypass problems with some AthAnalysisBase releases. Requested by Asoka de Silva et al. (ATLASExperiment)
Removed getLocalSpaceLimit() since it is not used any longer (Mover)
Replaced maxinputsize with maxwdir - 2000 in getMaxInputSize(). Requested by Alastair Dewhurst (pUtil)
Removed unused method testES() (RunJobEvent)
Created extractErrorMessage() (RunJobEvent)
Extracting error acronyms and diagnostics from AthenaMP yampl message in listener() (RunJobEvent)
Now using getModernASetup() with AnalysisTransform setups in getJobExecutionCommand(); requested by Asoka de Silva (ATLASExperiment)
Removed usage of 'region' in getProperSiterootAndCmtconfig() (ATLASExperiment)
Removed getProperSiterootAndCmtconfigOld() (ATLASExperiment)
Changed 'region' to 'cloud' in getProperASetup() (ATLASExperiment)
Removed unused region variable in getAnalysisRunCommand() (Experiment)
Removed unused region variable in __main__() (RunJob, RunJobEvent, RunJobAnselm, RunJobEdison)
Removed unnecessary error handling around updateEventRange() call in asynchronousOutputStager() (RunJobEvent)
Now forwarding failed error range to server, in listener() (RunJobEvent)
Added event service and token extractor error codes:
        ERR_ESFATAL: "Fatal Event Service error",
        ERR_TEHOSTNAME: "Token Extractor error: Host name could not be resolved",
	ERR_TEBADURL: "Token Extractor error: Bad URL",
	ERR_TEINVALIDGUID: "Token Extractor error: Invalid GUID length",
	ERR_TEWRONGGUID: "Token Extractor error: No tokens for this GUID"
used by RunJobEvent::listener() (PilotErrors, RunJobEvent)
Calling updateJobDefinition() from monitor_job() (Monitor)
Created optional updateJobDefinition() used to manipulate the job object/file after download from dispatcher (Experiment, ATLASExperiment)
Created readFile(), writeFile() (FileHandling)
Now updating the job object and job definition file in updateJobDefinition() (ATLASExperiment)
Renamed getAthenaMPSubprocess() to getSubprocess(), used by __main__() and getTokenExtractorProcess() (RunJobEvent)
Moved getSubprocess() from RunJobEvent to RunJob
Moved getStdoutStderrFileObjects() from RunJobEvent to RunJob
Created isMultiTrf(), used by setup(), executePayload() (RunJob)
Removed piping to stdout/err from getJobExecutionCommand() (ATLASExperiment)
Created tail() (FileHandling)
Now using getSubprocess() in executePayload() instead of commands.getstatusoutput() to execute payload (RunJob)
Overwriting job.coreCount if ATHENA_PROC_NUMBER is set in getJobMetrics() (PandaServerClient)
Overwriting job.coreCount if ATHENA_PROC_NUMBER is set in setJobDef() (Job)
Created addMAKEFLAGS(), used by getJobExecutionCommand() (ATLASExperiment)
Test import of rucio.client (pilot)
Always using default setup in setup(), i.e. CVMFS ROOT setup will always be used (xrdcpSiteMover)
Created checkSpecialEnvVars(), used to set new env variable 'Nordugrid_pilot' which in turn is used to identidy Nordugrid in other pilot classes (NordugridATLASExperiment)
Changed usage of 'region' to using env variable 'Nordugrid_pilot', and replaced 'Nordugrid' with 'ND' in checkSpecialEnvVars(), getSwbase(), getRelease() (ATLASExperiment)
Changed usage of 'region' to 'cloud', and replaced 'Nordugrid' with new env variable 'Nordugrid_pilot' in createFileMetadata() (RunJob, RunJobEvent)
Changed usage of 'region' to new env variable 'Nordugrid_pilot' in createMetadataForOutput(), postJobTask() (JobLog)
Changed usage of 'region' to new env variable 'Nordugrid_pilot' in _cleanUpEndedJobs() (Monitor)
Changed usage of 'region' to new env variable 'Nordugrid_pilot' in getRelease() (NordugridATLASExperiment)
Changed usage of 'region' to new env variable 'Nordugrid_pilot' in getXML(), updatePandaServer() (PandaServerClient)
Changed usage of 'region' to new env variable 'Nordugrid_pilot' in getDDMStorage(), getPoolFileCatalog(), getPoolFileCatalogDQ2(),
getFileInfoFromMetadata() (Mover)
Changed usage of 'region' to new env variable 'Nordugrid_pilot' in handleQueuedata() (pUtil)
Setting new env variable 'Nordugrid_pilot' also in argParser() since it will be needed before the experiment object is created (pilot)
Added "adler32" to if statement in getRemoteFileChecksumFromOutput() (xrdcpSiteMover)
Created convert() function, converting unicode strings and collections (lists, dictionaries, etc) to utf-8 (pUtil)
Created openFile() and getJSONDictionary() (FileHandling)
Created getMemoryUtilityCommand(), used by __main__() (RunJob)
Now querying shouldExecuteMemoryMonitor() before running findVmPeaks() in interpretPayloadStdout() (ATLASExperiment)
Created shouldExecuteMemoryMonitor(), getMemoryMonitorJSONFilename() (Experiment, ATLASExperiment)
Importing and using getExperiment() in getJobMetrics() (PandaServerClient)
Importing and using getJSONDictionary() in getJobMetrics() (PandaServerClient)
getJobMetrics() is now adding memory monitor JSON dictionary to job metrics (PandaServerClient)
Copying any JSON file from the jobs' workdir to the pilots' init dir in executePayload() (RunJob)
Verifying that token is not None in getPreDestination(), requested by Tadashi Maeno (SiteMover)

DQ2 API to Rucio API migration:
- Replaced isTapeSite() function, now using the Rucio client to check whether the site is a tape site or not (SiteMover)
- Created getFileInfoFromRucio() (SiteMover)
- Fall back mechanism in getFileInfo() is now using getFileInfoFromRucio(), in case file size and checksum was not sent sent with the job description (Mover)

Update info from Edward Karavakis:
- Now avoiding copying the glexec sandbox dir itself in the __ship_queue_data() from the PilotHomeDir, affecting jobs at ANALY_BNL_GLEXEC (glexec_utils)
- Loops through the files of the pilot dirs and chmods them so that they can be removed at the end of the glexec'ed payload
- Created temporary glexec sandbox inside the working directory / usual scratch area instead of the location of the TMPDIR env variable
- Properly removes the glexec sandbox directory at the end

Change to AMSTaiwanExperiment:
- Changed usage of 'region' to new env variable 'Nordugrid_pilot' in checkSpecialEnvVars(), getSwbase(), getRelease()

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

61b:

Reverted to using the old ToA based isTapeSite() since the new Rucio based method caused too much load on the Rucio server (SiteMover)

Update info from Edward Karavakis:
- Patch for the permission problem/bug with ARC+HTCondor affecting RAL and RAPP

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

61c:

Sending gpfn (replica) and sitemover to isFAXAllowed() from mover_get_data() (Mover)
Added surl and sitemover arguments to isFAXAllowed() (Mover)
Removed fax_mode argument from getCatalogFileList(), and its call in getPoolFileCatalog() since it is not needed (Mover)
Now verifying that a replica is not on TAPE before FAX can be used, in isFAXAllowed() (Mover)
Updated error message "Encountered an empty SURL-GUID dictionary" to "Rucio returned an empty replica dictionary" in verifySURLGUIDDictionary() (Mover)
Protection against triple slashes in updateRedirector() (FAXSiteMover)
Moved getExtension() from pUtil to FileHandling
Importing getExtension() from FileHandling, in moveToExternal() (pUtil)
Importing getExtension() from FileHandling instead of from pUtil (SiteInformation, ATLASSiteInformation, JobState, Mover, RunJob, RunJobEvent, SiteMover)
Removed import of unused getExtension (NordugridSiteInformation)
Moved dumpFile from pUtil to FileHandling
Importing dumpFile (pUtil, Mover)
Moved readJSON and writeJSON from FAXSiteMover to FileHandling
Created discoverAdditionalOutputFiles() (RunJob)
Now using discoverAdditionalOutputFiles() in __main__() (RunJob)

Tracing report update
- Added url and stateReason to getInitialTracingReport() (Mover)
- Created prepareReport() that will replace the __sendReport() in the site movers (SiteMover)
- Setting tracing report stateReason and url in sitemover_get_data() (Mover)
- Created getTracingReportFilename() (FileHandling)
- Removed __sendReport() (SiteMover, LocalSiteMover, xrdcp*, xrootd*, xrootdObject*, S3*, lcgcp*, dCache*, BNL*, Castor*, Chirp*, GFAL2*, GSIftp*, HU*, aria2c*, castorSvcClass*, curl*, rfcpLFC*)
- Now using prepareReport() instead of __sendReport() (SiteMover, LocalSiteMover, xrdcp*, xrootd*, xrootdObject*, S3*, lcgcp*, dCache*, BNL*, Castor*, Chirp*, GFAL2*, GSIftp*, HU*, aria2c*,
  castorSvcClass*, curl*, rfcpLFC*)
- Storing tracing report in JSON file in prepareReport (SiteMover)
- Now reading tracing report from file and finishing it in mover_get_data() (Mover)
- Now returning the surl for more cases with put_data_retfail() from put_data() to make sure the url in the tracing report is set (SiteMover, lcgcp*, BNLdCache*, Castor*, Chirp*, GSIftp*,
  HU*, aria2c*, curl*, dCache*, rfcpLFC*, xrootd*)


REMOVE OTHERSITEMOVER FROM DIST
HUSITEMOVER?


DQ2 API to Rucio API migration:
- Created new support methods: extractScopeLFN(), getScopeLFNListFromDictionary(), getGUIDForLFN() used by the new getRucioReplicaDictionary() (Mover)
- getRucioReplicaDictionary() now returns both a replica dictionary and a surl dictionary containing file type and RSE info (Mover)
- Receiving the new surl dictionary in getReplicaDictionaryRucio() (Mover)
- Added new data members to replica class: filetype and rse (Mover)
- Added new data members (filetype, rse) to replica object in getReplicaDictionaryRucio() (Mover)
- Created getFiletypeAndRSE() used by getReplicaDictionaryRucio() (Mover)
- Created getFiletype() used by getFileInfo() (Mover)
- Now storing filetype in surl_filetype_dictionary, in getCatalogFileList() (Mover)
- getCatalogFileList() now returns surl_filetype_dictionary, received in getPoolFileCatalog() (Mover)
- getPoolFileCatalog() now returns surl_filetype_dictionary, received in getFileInfo() (Mover)
- filetype is now extracted and returned by extractInputFileInfo(), received in mover_get_data() (Mover)
- Added filetype argument to isFAXAllowed() (Mover)
- filetype is now sent to isFAXAllowed() from mover_get_data() (Mover)
- Using filetype instead of isFileOnTape() in isFAXAllowed() (Mover)
- Added surl_filetype_dictionary argument to randomizeReplicas() (Mover)
- Sending surl_filetype_dictionary to randomizeReplicas() from getCatalogFileList() (Mover)
- Created getFiletypeFromDictionary(), used by getFileInfo() (Mover)
- Using getFiletypeFromDictionary() instead of calling isFileOnTape() in randomizeReplicas() (Mover)
- Using replica.filetype instead of calling isFileOnTape() in sortReplicas(), two times (Mover)
- Removed deprecated methods isFileOnTape() and isTapeSite() (SiteMover)
- Now finishing tracing report in sitemover_get_data(), sitemover_get_all_data(), chirp_put_data(), sitemover_put_data() (Mover)
- Replaced getFileCatalog() with trivial function returning <rucio default> string, since it is no longer needed (ATLASExperiment, AMSTaiwanExperiment)
- Returning empty list in getFileCatalogHosts() since it is no longer needed (ATLASExperiment, AMSTaiwanExperiment)
- Now using c.declare_suspicious_file_replicas instead of dq2.declareSuspiciousFiles in reportFileCorruption() to declare corrupt file (SiteMover)
- Created test method bulkRegisterFilesNew() (SiteMover)

Update info from Edward Karavakis:
- Patch 2+3 for the permission problem/bug with ARC+HTCondor affecting RAL and RAPP

Changed in AMSTaiwanSiteInformation:
- Importing getExtension() from FileHandling instead of from pUtil

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


TODO:

Prior to file registration (i.e. for US sites that still uses the pilot for file registrations), the pilot sets the LFC_HOST env variable; no longer needed for file 
registrations using DQ2 functions test with a job run in the US, BNL e.g. which still uses the pilot for file registrations

todo: remove the explicit usages of schedconfig.lfchost and replace with an experiment specific method (getFileCatalog())
todo: rename pUtil.getExperiment to pUtil.getExperimentObject, correct import in SiteInformation

#### add new error codes 1217-1219 to proddb
Update prodDB for ERR_RUNJOBEXC : "Exception caught by runJob" -> "Exception caught by RunJob*" ? not necessary??
Added new error codes; 1224 (ERR_ESRECOVERABLE), 1225 (ERR_ESMERGERECOVERABLE) (PilotErrors)
