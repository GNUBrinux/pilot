Complete change log for the Pilot 1
-----------------------------------


72.0

General changes:
- Added TURL to file state dictionary in stagein_real(), needed for direct access in prod jobs (mover)
- Now using proper job.isAnalysisJob() in __main__() (RunJob)
- Corrected exception handling in getContainerName() (Singularity)
- Removed sitename from detect_client_location, and from all it's calls (via stagein()), replaced with readpar (mover)
- Added movers to redundancy list in removeRedundantFiles() (ATLASExperiment)
- Now using isRootFileName() in is_directaccess() to determine whether the file is a root file or not (Job)

Now using associated storages when looking up replicas by getting all associated endpoints from astorages
- Using resolvePandaAssociatedStorages() instead of _prepare_input_ddm() in resolve_replicas() (mover)
- As discussed in thread "Multiple read DATADISK per PQ"

Resource type
- Added new pilot option -R <resourceType>, forwarded to dispatcher with getJob. Requested by Tadashi Maeno (pilot, Job)

Updates from Wen Guan:

You can view, comment on, or merge this pull request online at:

  https://github.com/PanDAWMS/pilot/pull/167

1. clean 'es_read' activity in pilot: 'es_read' was added to read remotely for cases to run ES when there is a local
storage downtime. It's not used.
2. to support failover for es: attach two storages in agis for ES, if the first one fails, it will failover to the
second storage. For the first storage, it will use 'es_events' activity if defined, otherwise it will use 'pw'
activity. So for opportunistic PQs, we need to define 'es_events', but for normal PQs, we can run ES without defining
'es_events'.
3. update the default zip_time_gap. If pledgedcpu is -1, default zip_time_gap is 600 s (10 minutes). Otherwise it's 2 hours.
4. based on es_failover, ES can support storages blacklisting: either es_events or es_failover can be blacklisted.

Commit Summary

clean "es_read" activity
to support failover for es stageout
update sleep time based on attempts
update to read zip_time_gap in agis
fix objectstore keypaire usage in failover storage
to support blacklist for ES

File Changes

M Mover.py (7)
M RunJobEvent.py (261)
M SiteInformation.py (52)
M movers/mover.py (29)

 https://github.com/PanDAWMS/pilot/pull/168

Commit Summary

in pilotErrorDiag report 'AllSuccess' when all events finish, to distinguish with lost heartbeat cases.
implement maxtime and softkill for es
to use "pr" activtiy to stagein local es premerge files
fail pilot if continously stageout fails

File Changes

M RunJobEvent.py (4)

  https://github.com/PanDAWMS/pilot/pull/171

Commit Summary

clean some old codes

File Changes

M RunJobEvent.py (56)

  https://github.com/PanDAWMS/pilot/pull/172

Commit Summary

fix a bug in mover which fails esmerge jobs

File Changes

M movers/mover.py (2)

  https://github.com/PanDAWMS/pilot/pull/173

Commit Summary

option to define maxwait for tail events

File Changes

M RunJobEvent.py (18)

  https://github.com/PanDAWMS/pilot/pull/175

Commit Summary

fix inFilePosEvtNum for ES and prefetcher

File Changes

M RunJobEvent.py (9)

  https://github.com/PanDAWMS/pilot/pull/177

Commit Summary

using read_lan to replace r activity for ddm
update es error report

File Changes

M RunJobEvent.py (49)
M movers/mover.py (2)

  https://github.com/PanDAWMS/pilot/pull/178

Commit Summary

fix pilotErrorCode when payload fails

File Changes

M RunJob.py (6)

  https://github.com/PanDAWMS/pilot/pull/180

Commit Summary

fix pilot bug which updated final state two times

File Changes

M Job.py (3)
M Monitor.py (9)
M UpdateHandler.py (8)

  https://github.com/PanDAWMS/pilot/pull/181

Commit Summary

fix

File Changes

M movers/mover.py (4)

Updates from Nicolo Magini

  https://github.com/PanDAWMS/pilot/pull/169

Rely only on inFilePosEvtNum flag from PanDA instead.
Fix for https://its.cern.ch/jira/browse/ATLASPANDA-409

Commit Summary

Do not assume in-file positional event ranges for prefetcher

File Changes

M RunJobEvent.py (2)

  https://github.com/PanDAWMS/pilot/pull/170

Commit Summary

Merge pull request #1 from PanDAWMS/main-dev
Fix broken resolve replicas for WAN access
Merge branch 'main-dev' of git://github.com/PanDAWMS/pilot into PanDAWMS-main-dev
Merge branch 'PanDAWMS-main-dev' into main-dev

File Changes

M RunJob.py (2)
M RunJobEvent.py (2)
M movers/mover.py (2)

  https://github.com/PanDAWMS/pilot/pull/176

Commit Summary

Pass multiple input files to prefetcher command line
Change inFilePosEvtNum to job parameter (not an event range parameter)

File Changes

M Job.py (9)
M RunJobEvent.py (42)

Updates from Alexey Anisenkov

  https://github.com/PanDAWMS/pilot/pull/179

Base Sitemovers workflow updates:

implemented proper direct_access handling both for ANALY and PROD jobs over LAN and WAN in sitemovers
set by default direct access mode enabled for Analy jobs but disabled for Prod jobs (in Job class)
isolated remoteinput allowed schemes into JobMover.remoteinput_allowed_schemas; for the moment 'root' is only considered as allowed schema.. but can be easily extended with davs, gsiftp, etc..
Note: currently, the getNewJob() function in pilot.py modifies direct_access_lan and direct_access_wan queuedata settings based on Job parameters (e.g. transferType, is Analy) which is duplicating and confusing and actually should not be handled there but moved instead to Job constructor Job.setJobDef (it should be enough just disable 2lines of queuedata modification below)

As a side effect resetting direct_access_lan/wan settings by getNewJob will ignore default direct access settings set in Job.setJobDef.

https://github.com/PanDAWMS/pilot/blob/main-dev/pilot.py#L2340

ec = env['si'].replaceQueuedataField("direct_access_lan", "False")
ec = env['si'].replaceQueuedataField("direct_access_wan", "False")

Commit Summary

base sitemovers workflow updates:
typo fixes
cosmetic fix

File Changes

M Job.py (18)
M movers/base.py (2)
M movers/mover.py (228)

  https://github.com/PanDAWMS/pilot/pull/182

Updates:

implemented base functionality to parse and overwrite data passed via jobPars settings
introduced --overwriteAGISdata arg option to overwrite queuedata coming from AGIS
added copytools and acopytools entries to overwriteAGISdata, update affected stagein/out functions
The format of overwriteAGISdata command line option in JobParameters is a string representation of python structures (need to be overwritten)

e.g.

jobPars = '
--overwriteAGISdata "{\'allowfax\':False,\'copytools\':{\'rucio\':{\'setup\':\'fakesetup.sh\'}, \'acopytools\':{\'pr\':[\'rucio\']}}"
'
to simply overwrite queuedata both for stage-in and stage-out (e.g. by HC jobs) and force use of Rucio sitemover following settings can be passed:

--overwriteAGISdata "{'copytools':{'rucio':{'setup':''}, 'acopytools':{}}"

Commit Summary

- implement base functionality to overwrite AGIS queuedata passed via jobPars settings
cosmetic fix: exclude None values from being parsed by overwrite AGIS queue data

File Changes

M Job.py (56)
M SiteInformation.py (16)
M movers/mover.py (7)

  https://github.com/PanDAWMS/pilot/pull/183

Commit Summary

bugfix of job.parseJobPars() function
cosmetic

File Changes

M Job.py (10)

  https://github.com/PanDAWMS/pilot/pull/184

stage-in updates:

first process files which can be potentially used for direct access to exclude them from available space checks
exclude available space checks during stage-in for mv and storm site movers
clean up

Commit Summary

exclude available space checks during stage-in for mv and storm sitemovers
stagein logic updates: first process files which can be potentially used for direct access to exclude them from available space checks
cleanup of FileSpec.is_directaccess

File Changes

M Job.py (14)
M movers/base.py (1)
M movers/mover.py (4)
M movers/mv_sitemover.py (17)
M movers/storm_sitemover.py (8)

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

72.1:

General changes:
- Updated base path to containers (atlas.cern.ch/repo/containers/images/singularity) in getGridImageForSingularity() (Singularity)
- Updated default container platform to x86_64-centos6 (Singularity)

Updates from Wen Guan:

  https://github.com/PanDAWMS/pilot/pull/186

Commit Summary

fix pandaproxy usage

File Changes

M RunJobEvent.py (4)

  https://github.com/PanDAWMS/pilot/pull/187

Commit Summary

updated ways to resolve storages

File Changes

M RunJobEvent.py (6)

Updates from Alexey Anisenkov

  https://github.com/PanDAWMS/pilot/pull/188

Commit Summary

bugfix of direct access logic over WAN (only first file was considered for remote read)

File Changes

M movers/mover.py (24)

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

72.2:

General changes:
(
Temporarily reverted due to a comment made by A. Filipcic - the -I option can cause problems on some systems. Need to be investigated further.

- Changed hostname -i to hostname -I in collectMachineFeatures() and getBenchmarkCommand(). Requested by Alastair Dewhurst:
"[hostname -i] will only list the IPv4 address on a dual stack machine.  Which can cause confusion if debugging problems.
If you change the command to "hostname -I" (a capital "i"), then it will print out all addresses the host has (eg both the IPv4 and IPv6 address)"
 (ATLASSiteInformation, Node)
)
- Updated error message for stage-in exceptions (grammar) (mover)

Checksum problem:
- Now using calc_file_checksum() from movers/base module instead of old adler32() which can give a partial result in case
  zlib.adler32() throws an exception. Reported by R. Walker. (SiteMover)

Write PandaIDs to file
- Added mode argument to writeFile() (FileHandling)
- Now writing PandaID to file used by the wrapper in getNewJob(). Requested by P. Love (pilot)

Updates from Wen Guan:

  https://github.com/PanDAWMS/pilot/pull/189

Pilot now checks a site’s state on the DDM blacklist, rather than just check if the site is on the list (Requested by Wei Yang).

Commit Summary

fix the ddmblacklist checks

File Changes

M RunJobEvent.py (8)

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

72.3

Support for Harvester job request file:


Updates from Wen Guan:

  https://github.com/PanDAWMS/pilot/pull/190

Commit Summary

to kill AthenaMP if it doesn't response in max_wait
fix one state which caused RunJobHpcEvent to be killed before finishing all tails

File Changes

M RunJobEvent.py (9)
RunJobHpcEvent

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


TODO:

todo: remove the explicit usages of schedconfig.lfchost and replace with an experiment specific method (getFileCatalog())
todo: rename pUtil.getExperiment to pUtil.getExperimentObject, correct import in SiteInformation

#### add new error codes 1217-1219 to proddb
Update prodDB for ERR_RUNJOBEXC : "Exception caught by runJob" -> "Exception caught by RunJob*" ? not necessary??
Added new error codes; 1224 (ERR_ESRECOVERABLE), 1225 (ERR_ESMERGERECOVERABLE) (PilotErrors)
