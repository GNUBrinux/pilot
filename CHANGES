
make sure MAKEFLAGS is set in the new setup function!!!

Test failover to alt OS at UTA. code implemented. fake initial failure in S3 site mover






Complete change log for PanDA Pilot version PICARD
--------------------------------------------------


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

63.4:

Now verifying that nentries is actually an integer (can aparently be 'null') in extractOutputFilesFromJSON() (FileHandling)
Now using allowNoOutput list in extractOutputFilesFromJSON() to know when an empty file can be ignored (FileHandling)
Added allowNoOutput to Job class, including handling (Job)
Now sending job.allowNoOutput list to extractOutputFilesFromJSON() (RunJob)
Overriding the input file guid for the TE input file list in __main__() (RunJobEvent)
Adding a random string to the yampl channel name in __init__() (RunJobEvent)
Telling AthenaMP the name of the yampl channel in __main__() (RunJobEvent)
Updated getMaxMemoryUsageFromCGroups() and removed the need for ATLAS_CGROUPS_BASE (processes)
Created getCGROUPSBasePath() used by getMaxMemoryUsageFromCGroups() (processes)
Updated isCGROUPSSite() to use getCGROUPSBasePath() instead of using ATLAS_CGROUPS_BASE (processes)
Added support for AthSimulation* releases (e.g. for jobs with homePackage=AthSimulationBase/1.0.3) in getProperASetup() and getProperSiterootAndCmtconfig() (ATLASExperiment)
Created getSiterootWithHomepackage(), used by getProperSiterootAndCmtconfig() and getProperASetup() (ATLASExperiment)
Created getSplitHomePackage() used by getSiterootWithHomepackage(), getProperASetup() (ATLASExperiment)
Now extracting output files from jobReport for user jobs as well in __main__() (RunJob)
Avoiding adding cmt setup (getProdCmd2() call) for AthSimulation* releases in getJobExecutionCommand() (ATLASExperiment)
Updated xml source string from "NG Panda server" to "aRC" in getPoolFileCatalogNG() (Mover)
Renamed function getPoolFileCatalogNG() to getPoolFileCatalogND() (Mover)
Updated getFiletypeFromDictionary() to handle ND properly (filetype DISK is implied) (Mover)
Now setting copytool for ND in extractCopytoolForPFN() (Mover)
Using readlink to unfold any soft linked file paths in put_data() (mvSiteMover)

63.4.1:

Avoiding extracting output files from jobReport.json for user jobs in __main__() (RunJob)

63.4.2:

Added exit code 11 and error acronym TRF_OUTPUT_FILE_ERROR to ignore list in __main__() (RunJobEvent)
Sending job.taskID to downloadEventRanges() from executePayload() and __main__() (RunJob, RunJobEvent)
Added taskID argument to downloadEventRanges() (EventRanges)
Now sending taskID with GETEVENTRANGES server request in downloadEventRanges(); requested by Tadashi Maeno (EventRanges)
Now sending taskID with GETEVENTRANGES server request in getJobEventRanges(); requested by Tadashi Maeno (RunJobHpcEvent)
Now importing isAGreaterOrEqualToB() (RunJobEvent)
Created useTokenExtractor(), setUseTokenExtractor() (RunJobEvent)
Now using useTokenExtractor in several places in __main__() (RunJobEvent)
Corrected preExec setting in __main__() (RunJobEvent)
Added protection for failure to find alternativeName in getTiersOfATLASAlternativeName() (SiteMover)

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

64.0

LOCAL SITE MOVER XXX

TODO: update pUtil::getStdoutDictionary() to support the tail of the last updated AthenaMP log file; also update PandaServerClient::updatePandaServer() to
take the latest log file and send it to the text indexer in debug mode (see Rod's mail on Nov. 24)

DO NOT KILL JOBS THAT EXCEEDED MAX MEMORY!!!




General changes:
- Replaced useFileStager and directIn with _dummy strings in getPrefices() and shouldPFC4TURLsBeCreated() since they are not used in these functions (Mover)
- Now getting the value of directIn from useDirectAccessLAN() instead of from getFileAccessInfo() in shouldPFC4TURLsBeCreated() (Mover)
- Replaced useFileStager and directIn with _dummy in stageIn() since they are not used (RunJob)
- Removed import of getFileAccessInfo() since it is not used (RunJobEvent)
- Created getDirectAccess(), used by shouldPFC4TURLsBeCreated() (Mover)
- Simplified getFileAccessInfo() (pUtil)
- Updated return values from getFileAccessInfo() in getPrefices() and shouldPFC4TURLsBeCreated() (Mover)
- Updated return values from getFileAccessInfo() in stageIn() (RunJob)
- Now using useDirectAccessWAN() in getPoolFileCatalog() to determine if a PFC with direct I/O over FAX should be produced (Mover)
- Now failing immediately if PFC could not be created in getPoolFileCatalog() (Mover)
- Simplified willDoFileLookups() (ATLASExperiment)
- Avoiding None value while getting number of events in processMetadata() (ATLASExperiment)
- Ignoring test mode in updateJobStateTest() (JobRecovery)
- Removing archive files if present prior to log file creation; requested by Emmanouil Vamvakopoulos et al (ATLASExperiment)

General bug fixes:
- Corrected bad return (function returned pilotErrorDiag string, but should have returned an outputRet dictionary) in errorToReport(); caused timed-out jobs at BNL
to get the wrong error label (LocalSiteMover)
- Corrected usage of new method processCanBeKilled() (missing self; also in its call in __updateJobs()) (Monitor)
- Removed half-implemented getFilenamesAndGuid() (Mover)
- Changed 'eventservice' to 'logs' in transferLogFile() before adding info to OS transfer dictionary (JobLog)
- Added missing MAKEFLAGS for ND jobs, in setupNordugridTrf() (NordugridATLASExperiment)

Setup of ATLAS Release changes
- Created a new getJobExecutionCommand(), renamed old function to getJobExecutionCommandOld() (ATLASExperiment)
- Changed useAtlasSetup() to always return True for all releases (ATLASExperiment)
- Updated getSplitHomePackage() to handle AnalysisTransforms-AtlasP1HLT_* correctly (ATLASexperiment)
- Now using getSplitHomePackage() in getJobExecutionCommand() (ATLASExperiment)

Added fail-over to alternative OS
- Created copyFullQueuedata(), getFullQueuedataDictionary(), findOSEnabledQueuesInFullQueuedata(), findAllObjectStores(), getAlternativeOS(), getFullQueuedataFilePath() (SiteInformation, ATLASSiteInformation)

Memory monitoring updates:
- Calling __check_memory_usage() in monitoring loop, in monitor_job() (Monitor)
- Created merge_dictionaries() (pUtil)
- Now importing merge_dictionaries (PandaServerClient)
- Moved getUtilityInfo() from PandaServerClient to ATLASExperiment
- Created empty getUtilityInfo() (Experiment)
- Updated call to getUtilityInfo() in getNodeStructure() (PandaServerClient)
- Now importing getJSONDictionary in ATLASExperiment
- Created getUtilityOutputFilename() used by getUtilityCommand() (ATLASExperiment, Experiment)
- Created new error code ERR_PAYLOADEXCEEDMAXMEM, 1235, "Payload exceeded maximum allowed memory" (PilotErrors)
- Now using getJSONDictionary() in getJobReport() to avoid problems with unicode seen in test jobs (FileHandling)
- Created parseUtilityOutput() (ATLASExperiment)
- Creating a lockfile in __check_memory_usage() to prevent the MemoryMonitor to restart after it has been killed (Monitor)
- Avoiding restart of memory monitor in __main__() if lockfile MEMORYEXCEEDED is found (RunJob, RunJobEvent)
- Added purge argument to getUtilityInfo() (PandaServerClient)
- Now sending purge=True to getUtilityInfo() from getNodeStructure() (PandaServerClient)
- Sending workdir to getUtilityCommand() from getUtilitySubprocess() (RunJob)
- Extracting argument workdir in getUtilityCommand() (ATLASExperiment)
- Changing to workdir before utility command is executed in getUtilityCommand() (ATLASExperiment)
- Improved reading of memory_monitor_summary.json in getUtilityInfo() (ATLASExperiment)
- Corrected time() -> time.time() in getUtilityInfo() (ATLASExperiment)
- Created getMemoryValues() and getMaxUtilityValue() (ATLASExperiment)
- Created getUtilityInfoPath() used by getUtilityInfo() and getMemoryValues() (ATLASExperiment)
- __check_memory_usage() now using getMemoryValues() (Monitor)
- Added allowTxtFile option to getUtilityInfo() (ATLASExperiment)
- Added pilot_initdir, allowTxtFile arguments to getUtilityInfo() (Experiment)
- Added allowTxtFile argument to getUtilityInfo() (ATLASExperiment)
- Removed getTracingReportFilename, writeJSON from import list (xrdcpSiteMover)

LFC cleanup:
- Removed getLFCDir(), lfc_mkdir(), lcg_rf() (SiteMover)
- Ignoring empty lFC paths from getLFCPath() call in getProperPaths()
- Protecting against empty lfcpaths in getUserLFCDir() (SiteMover)
- Removed obsolete function getLFCChecksumType() (SiteMover)
- Removed obsolete function addMD5sum() (castorSvcClassSiteMover, dCacheLFCSiteMover, rfcpLFCSiteMover)

Time-out changes:
- Protected against exitcode None being sent in run() (TimerCommand)

Logging changes: (mainly invisible changes in this version)
- Change default log file name from pilotlog.out to pilotlog.txt (pUtil)
- Added new logging module to distribution: Logger.py with code constributions from Wen Guan (logging) and Jose Caballero (formatting)
- Created new global essentialPilotlogFilename (pUtil)
- Setting new global essentialPilotlogFilename in setPilotlogFilename() (pUtil)
- Added arguments label and essential to tolog() (pUtil)

Code cleanup: (apart from Mario's cleanup)
- Removed outdated getPoolFileCatalogDQ2() (Mover)
- Removed usages of rsespace variable in monitor_job() and monitor_recovery_job() (Monitor)
- Removed rsespace and rsespmsg from setSiteInfo() (Site)
- Removed usages of rsespace and rsespmsg, and sending remainingSpace and messageLevel to server from getNodeStructure() (PandaServerClient)

Update from Danila Oleynik, Taylor Childers:
- New modules: ArgoJob, RunJobArgo, BalsamJob, MessageInterface
- Updated RunJobFactory; replaced Mira with Argo
- Added functions to serialize ARGO messages: serialize(), deserialize(), convert_unicode_string() (pUtil)

Update from Wen Guan:
- Added EventStager module for HPC Nersc
- Added GetJob module for getting multiple jobs
- Update EventServerManager to let it run in a sub-process. Before it was running in the current process, in this case it cannot be switched to another job which is needed by multi-jobs Yoda.
- In EventServerManager add functions to handle AthenaMP error messages.
- Update to use bulk event ranges updates to panda server
- Fix cases where all ranks of Yoda were killed when one rank finished.
- Update HPCManager to handle multi-jobs.
- Update Yoda database function to fix the bottleneck which was slow to update db changes
- Update Yoda Interaction module to fix the messages delay
- Update Yoda and Droid to handle multi-jobs
- Add Signal_block module in Yoda to make Yoda soft termination
- Update monitor module to monitor multi-jobs, terminate multi-jobs, handle multi-jobs logs and recover HPC jobs
- Restored is_secure variable which got lost in the merging process (S3ObjectstoreSiteMover)

Update from Mario Lassnig Mario Lassnig:
- Code cleanup in various pilot modules

Update from Alexey Anisenkon:
- Job stage-in base workflow implemented:
- . direct access support
- . no FAX for stagein
- . no DBReleases (as special input case) support
- . FileSpec object integration for stagein
- . xrdcp mover: get functionality implemented
- . Job object updates
- . other mover related updates

Update from Daniil Drizhuk:
- New job recovery algorithm implemented (DeferredStageout module)

REMOVE RunJobMira.py FROM DISTRIBUTION

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


TODO:

Remove singletons:
- Change __experiment to experiment in Experiment classes
- Use super() in __init__() (ATLASExperiment)
- Same changes to SiteInformation classes

62.1?
Avoiding setting exit code 1008/65 when no jobs were downloaded in getJob(), requested by John Hover (pilot)

REMOVE OTHERSITEMOVER FROM DIST
HUSITEMOVER?

Prior to file registration (i.e. for US sites that still uses the pilot for file registrations), the pilot sets the LFC_HOST env variable; no longer needed for file
registrations using Rucio functions test with a job run in the US, BNL e.g. which still uses the pilot for file registrations

todo: remove the explicit usages of schedconfig.lfchost and replace with an experiment specific method (getFileCatalog())
todo: rename pUtil.getExperiment to pUtil.getExperimentObject, correct import in SiteInformation

#### add new error codes 1217-1219 to proddb
Update prodDB for ERR_RUNJOBEXC : "Exception caught by runJob" -> "Exception caught by RunJob*" ? not necessary??
Added new error codes; 1224 (ERR_ESRECOVERABLE), 1225 (ERR_ESMERGERECOVERABLE) (PilotErrors)
